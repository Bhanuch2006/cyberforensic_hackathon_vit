<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>LogChef // BIG_DATA_EDITION</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: { mono: ['"VT323"', "monospace"] },
            colors: {
              bg: "#020202",
              panel: "#09090b",
              border: "#3f3f46",
              neon: {
                green: "#00ff41",
                red: "#ff003c",
                blue: "#00f3ff",
                yellow: "#ffee00",
                purple: "#bc13fe", 
              },
            },
            animation: {
              'spin-slow': 'spin 3s linear infinite',
              'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            },
          },
        },
      };
    </script>

    <style>
      /* --- RETRO AESTHETICS --- */
      body { background-color: #000; color: #00ff41; font-family: 'VT323', monospace; font-size: 1.15rem; overflow: hidden; }
      
      .scanlines {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.15) 50%, rgba(0,0,0,0.15));
        background-size: 100% 3px; pointer-events: none; z-index: 50;
      }
      
      .cyber-panel {
        background: rgba(5, 5, 5, 0.95); border: 1px solid #333; position: relative;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.9);
      }
      
      .cyber-input {
        background: #000; border: 1px solid #333; color: #00ff41; padding: 0.5rem; width: 100%; outline: none; transition: all 0.2s;
      }
      .cyber-input:focus { border-color: #00ff41; box-shadow: 0 0 8px rgba(0, 255, 65, 0.2); }
      
      .btn-cyber {
        background: rgba(0, 51, 0, 0.3); border: 1px solid #00ff41; color: #00ff41; padding: 4px 16px; cursor: pointer; text-transform: uppercase; transition: all 0.2s;
      }
      .btn-cyber:hover { background: #00ff41; color: #000; box-shadow: 0 0 15px #00ff41; }
      .btn-cyber:disabled { border-color: #333; color: #555; cursor: not-allowed; background: transparent; box-shadow: none; }

      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 10px; height: 10px; background: #000; }
      ::-webkit-scrollbar-thumb { background: #111; border: 1px solid #333; }
      ::-webkit-scrollbar-thumb:hover { background: #00ff41; }

      /* Table Interaction */
      tr.log-row:hover td { background: rgba(0, 255, 65, 0.1); color: #fff; cursor: crosshair; }
    </style>
  </head>

  <body class="flex flex-col h-screen p-4 gap-4 selection:bg-neon-green selection:text-black">
    <div class="scanlines"></div>
    
    <div id="loading-screen" class="fixed inset-0 bg-black z-[100] hidden flex-col items-center justify-center">
        <div class="text-neon-green text-4xl font-bold animate-pulse mb-4">INITIALIZING_BIG_DATA_PROTOCOL...</div>
        <div class="w-64 h-4 border border-neon-green p-1">
            <div id="loading-bar" class="h-full bg-neon-green w-0 transition-all duration-300"></div>
        </div>
        <div class="mt-2 text-gray-500 font-mono" id="loading-text">PARSING 0 RECORDS...</div>
    </div>

    <header class="flex-none flex items-center justify-between border-b border-gray-800 pb-3 mb-2 relative z-20">
        <div class="flex items-center gap-4">
            <h1 class="text-4xl font-bold tracking-widest flex items-center gap-2">
                üõ°Ô∏è ForensIQ <span class="text-gray-600 text-2xl">//</span> <span class="text-neon-yellow">LOGS</span>
            </h1>
            <div id="file-badge" class="hidden text-xs border border-neon-blue text-neon-blue px-2 py-1">
                DATA_MOUNTED
            </div>
        </div>
        
        <div class="flex items-center gap-6">
            <label class="btn-cyber flex items-center gap-2 group">
                <span class="group-hover:animate-pulse">>>> UPLOAD_LARGE_CSV</span>
                <input type="file" id="csv-upload" accept=".csv" class="hidden">
            </label>
        </div>
    </header>

    <div class="flex-1 flex gap-4 overflow-hidden relative z-10">
        
        <aside class="w-64 flex-none flex flex-col gap-4" id="sidebar">
            <div class="cyber-panel p-4">
                <h3 class="text-gray-500 text-xs mb-2 uppercase tracking-widest border-b border-gray-800 pb-1">System_Integrity</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>Total Records</span>
                        <span class="text-white font-bold" id="stat-total">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Filtered</span>
                        <span class="text-neon-yellow" id="stat-filtered">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Page</span>
                        <span class="text-neon-blue"><span id="page-current">1</span> / <span id="page-total">1</span></span>
                    </div>
                </div>
            </div>

            <div class="cyber-panel p-4 flex-1 overflow-y-auto flex flex-col">
                <h3 class="text-neon-yellow text-sm mb-3 uppercase tracking-widest border-b border-gray-800 pb-1">
                    > Detected_Fields
                </h3>
                <div id="facets-container" class="space-y-1 text-sm text-gray-400 font-mono">
                    <div class="text-center italic opacity-50 mt-10">waiting for stream...</div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col gap-4 min-w-0">
            
            <div class="cyber-panel p-4 flex flex-col gap-2">
                <div class="flex justify-between items-center mb-1">
                    <div class="text-xs font-bold text-neon-green">SQL_FILTER_MODE</div>
                    <span class="text-xs text-gray-500">CTRL+ENTER TO EXECUTE</span>
                </div>
                <div class="relative">
                    <input type="text" id="query-input" 
                        class="cyber-input" 
                        placeholder="Type to filter (e.g. '192.168', 'ERROR', 'admin')..." 
                        autocomplete="off">
                </div>
            </div>

            <div class="cyber-panel flex-1 flex flex-col min-h-0 bg-black">
                <div class="flex-none overflow-hidden border-b border-gray-800 bg-panel">
                    <table class="w-full text-left text-sm whitespace-nowrap">
                        <thead class="text-gray-500 font-mono text-xs uppercase" id="table-head">
                            </thead>
                    </table>
                </div>

                <div class="flex-1 overflow-auto" id="table-container">
                    <table class="w-full text-left text-sm whitespace-nowrap">
                        <tbody id="table-body" class="font-mono text-gray-300">
                            <tr>
                                <td class="p-8 text-center text-gray-600">
                                    <div class="mb-2 text-4xl opacity-20">üìÇ</div>
                                    <div>NO DATA LOADED</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="p-2 bg-panel border-t border-gray-800 flex justify-between items-center">
                    <div class="text-xs text-gray-500" id="row-info">0 - 0 of 0</div>
                    <div class="flex gap-2">
                        <button class="btn-cyber text-xs" onclick="changePage('first')">|&lt;</button>
                        <button class="btn-cyber text-xs" onclick="changePage(-1)">&lt; PREV</button>
                        <button class="btn-cyber text-xs" onclick="changePage(1)">NEXT &gt;</button>
                        <button class="btn-cyber text-xs" onclick="changePage('last')">&gt;|</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let RAW_DATA = [];      // The full 700k rows
        let FILTERED_DATA = []; // The search results
        let HEADERS = [];
        
        // --- PAGINATION SETTINGS ---
        let CURRENT_PAGE = 1;
        const ROWS_PER_PAGE = 100; // Render 100 at a time for speed

        // --- 1. FILE UPLOAD & PARSING ---
        document.getElementById('csv-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // UI Updates
            const loader = document.getElementById('loading-screen');
            const loadBar = document.getElementById('loading-bar');
            const loadText = document.getElementById('loading-text');
            
            loader.classList.remove('hidden');
            loader.style.display = 'flex';
            document.getElementById('file-badge').classList.remove('hidden');
            document.getElementById('file-badge').innerText = `SOURCE: ${file.name}`;

            // Use PapaParse logic (manually implemented for zero-dependency)
            // or simple split for raw speed. For 700k lines, we use a chunked approach 
            // via setTimeout to keep UI responsive.
            
            const reader = new FileReader();
            
            reader.onload = function(event) {
                const text = event.target.result;
                loadText.innerText = "PARSING TEXT STREAM...";
                loadBar.style.width = "50%";

                // Give UI a moment to render
                setTimeout(() => {
                    parseLargeCSV(text);
                }, 100);
            };
            
            reader.readAsText(file);
        });

        function parseLargeCSV(text) {
            const lines = text.split('\n'); // Fast split
            if (lines.length < 2) return;

            // Header
            HEADERS = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            
            // Body - This is the heavy part
            // We map simply. For complex CSVs with commas inside quotes, 
            // a regex parser is needed, but split(',') is 100x faster for logs.
            
            RAW_DATA = [];
            
            // Optimization: Pre-allocate if possible, or just push
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if(!line) continue;
                
                const values = line.split(','); // Simple split for speed
                const row = {};
                
                // If row has trailing commas or issues, we try to handle gracefully
                for(let j=0; j<HEADERS.length; j++) {
                    let val = values[j] || '';
                    val = val.replace(/^"|"$/g, '');
                    row[HEADERS[j]] = val;
                }
                RAW_DATA.push(row);
            }

            // Init State
            FILTERED_DATA = RAW_DATA;
            CURRENT_PAGE = 1;
            
            // Hide Loader
            document.getElementById('loading-bar').style.width = "100%";
            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
                updateStats();
                renderHeaders();
                renderFacets();
                renderTable();
            }, 500);
        }

        // --- 2. RENDERING LOGIC (The Secret Sauce) ---
        function renderHeaders() {
            const thead = document.getElementById('table-head');
            let html = '<tr>';
            HEADERS.forEach(h => {
                html += `<th class="p-3 border-b border-gray-700 w-32 truncate" title="${h}">${h}</th>`;
            });
            html += '</tr>';
            thead.innerHTML = html;
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            const tableContainer = document.getElementById('table-container');
            
            // Calculate slice
            const start = (CURRENT_PAGE - 1) * ROWS_PER_PAGE;
            const end = start + ROWS_PER_PAGE;
            const pageData = FILTERED_DATA.slice(start, end);

            // Scroll to top
            tableContainer.scrollTop = 0;

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="100" class="p-8 text-center text-gray-500">NO MATCHES FOUND</td></tr>';
                return;
            }

            // Use DocumentFragment for speed
            const fragment = document.createDocumentFragment();

            pageData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'log-row border-b border-gray-900 transition-colors';
                
                HEADERS.forEach(header => {
                    const td = document.createElement('td');
                    td.className = 'p-3 truncate max-w-xs';
                    const val = row[header] || '-';

                    // Color Coding Logic
                    const vLower = val.toLowerCase();
                    if (vLower.includes('error') || vLower.includes('critical')) {
                        td.classList.add('text-neon-red', 'font-bold');
                    } else if (vLower.includes('warn')) {
                        td.classList.add('text-neon-yellow');
                    } else {
                        td.classList.add('text-gray-400');
                    }

                    td.textContent = val;
                    tr.appendChild(td);
                });
                fragment.appendChild(tr);
            });

            tbody.innerHTML = '';
            tbody.appendChild(fragment);

            updatePaginationUI();
        }

        // --- 3. SEARCH ENGINE ---
        const queryInput = document.getElementById('query-input');
        
        // Debounce search so we don't freeze while typing
        let searchTimeout;
        queryInput.addEventListener('keyup', (e) => {
            clearTimeout(searchTimeout);
            if(e.key === 'Enter') {
                performSearch();
            } else {
                searchTimeout = setTimeout(performSearch, 300);
            }
        });

        function performSearch() {
            const query = queryInput.value.toLowerCase();
            
            if (!query) {
                FILTERED_DATA = RAW_DATA;
            } else {
                // Filter logic
                FILTERED_DATA = RAW_DATA.filter(row => {
                    // Check all values in row
                    return Object.values(row).some(val => 
                        String(val).toLowerCase().includes(query)
                    );
                });
            }
            
            CURRENT_PAGE = 1; // Reset to page 1 on search
            updateStats();
            renderTable();
        }

        // --- 4. PAGINATION & UTILS ---
        function changePage(action) {
            const maxPages = Math.ceil(FILTERED_DATA.length / ROWS_PER_PAGE);
            
            if (action === 'first') CURRENT_PAGE = 1;
            else if (action === 'last') CURRENT_PAGE = maxPages;
            else CURRENT_PAGE += action;

            // Bounds check
            if (CURRENT_PAGE < 1) CURRENT_PAGE = 1;
            if (CURRENT_PAGE > maxPages) CURRENT_PAGE = maxPages;

            renderTable();
        }

        function updatePaginationUI() {
            const total = FILTERED_DATA.length;
            const maxPages = Math.ceil(total / ROWS_PER_PAGE) || 1;
            const start = (CURRENT_PAGE - 1) * ROWS_PER_PAGE + 1;
            let end = CURRENT_PAGE * ROWS_PER_PAGE;
            if (end > total) end = total;
            if (total === 0) { start = 0; end = 0; }

            document.getElementById('row-info').innerText = `${start} - ${end} of ${total}`;
            document.getElementById('page-current').innerText = CURRENT_PAGE;
            document.getElementById('page-total').innerText = maxPages;
        }

        function updateStats() {
            document.getElementById('stat-total').innerText = RAW_DATA.length.toLocaleString();
            document.getElementById('stat-filtered').innerText = FILTERED_DATA.length.toLocaleString();
        }

        function renderFacets() {
            const container = document.getElementById('facets-container');
            let html = '';
            HEADERS.forEach(h => {
                html += `
                    <div class="group flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="addFilter('${h}')">
                        <span>> ${h}</span>
                        <span class="text-gray-600 group-hover:text-neon-green text-xs">[ADD]</span>
                    </div>`;
            });
            container.innerHTML = html;
        }

        function addFilter(field) {
            queryInput.value += `${field} `;
            queryInput.focus();
        }
    </script>
  </body>
</html>